<div class="container">
    <h1>Gestión de Usuarios</h1>
    
    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" id="btnNuevoUsuario">
            <i class="bi bi-plus"></i> Nuevo Usuario
        </button>
        <div class="input-group" style="width: 300px;">
            <input type="text" class="form-control" placeholder="Buscar usuario..." id="buscarUsuario">
            <button class="btn btn-outline-secondary" type="button" id="btnBuscar">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Usuario</th>
                    <th>Nombre Completo</th>
                    <th>Email</th>
                    <th>Perfil</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaUsuarios">
                <!-- Datos se cargarán dinámicamente -->
            </tbody>
        </table>
    </div>
    
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center" id="paginacion">
            <!-- Paginación se generará dinámicamente -->
        </ul>
    </nav>
</div>

<!-- Modal para agregar/editar usuario -->
<div class="modal fade" id="usuarioModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitulo">Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="usuarioForm">
                    <input type="hidden" id="idUsuario">
                    <div class="mb-3">
                        <label for="usuario" class="form-label">Usuario</label>
                        <input type="text" class="form-control" id="usuario" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombreCompleto" class="form-label">Nombre Completo</label>
                        <input type="text" class="form-control" id="nombreCompleto" required>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="contrasena" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="contrasena">
                        <small class="text-muted">Dejar en blanco para no cambiar</small>
                    </div>
                    <div class="mb-3">
                        <label for="idPerfil" class="form-label">Perfil</label>
                        <select class="form-select" id="idPerfil" required>
                            <!-- Opciones se cargarán dinámicamente -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarUsuario">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const usuarioModal = new bootstrap.Modal(document.getElementById('usuarioModal'));
        let perfiles = [];
        
        // Cargar perfiles para el select
        fetch('https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/perfiles.php')
            .then(response => response.json())
            .then(data => {
                perfiles = data;
                const select = document.getElementById('idPerfil');
                select.innerHTML = data.map(perfil => 
                    `<option value="${perfil.idPerfil}">${perfil.nombrePerfil}</option>`
                ).join('');
                
                // Cargar usuarios
                cargarUsuarios();
            });
        
        // Abrir modal para nuevo usuario
        document.getElementById('btnNuevoUsuario').addEventListener('click', function() {
            document.getElementById('modalTitulo').textContent = 'Nuevo Usuario';
            document.getElementById('usuarioForm').reset();
            document.getElementById('idUsuario').value = '';
            document.getElementById('contrasena').required = true;
            usuarioModal.show();
        });
        
        // Guardar usuario
        document.getElementById('btnGuardarUsuario').addEventListener('click', function() {
            const formData = {
                idUsuario: document.getElementById('idUsuario').value,
                usuario: document.getElementById('usuario').value,
                nombreCompleto: document.getElementById('nombreCompleto').value,
                email: document.getElementById('email').value,
                contrasena: document.getElementById('contrasena').value,
                idPerfil: document.getElementById('idPerfil').value
            };
            
            const url = formData.idUsuario ? 'https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/usuarios.php' : 'https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/usuarios.php';
            const method = formData.idUsuario ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + JSON.parse(localStorage.getItem('user')).idUsuario
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    usuarioModal.hide();
                    cargarUsuarios();
                } else {
                    alert('Error al guardar el usuario: ' + (data.error || ''));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        });
        
        // Buscar usuarios
        document.getElementById('btnBuscar').addEventListener('click', cargarUsuarios);
        document.getElementById('buscarUsuario').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') cargarUsuarios();
        });
        
        // Función para cargar usuarios
        function cargarUsuarios(pagina = 1) {
            const busqueda = document.getElementById('buscarUsuario').value;
            
            fetch(`https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/usuarios.php?q=${encodeURIComponent(busqueda)}`)
                .then(response => response.json())
                .then(data => {
                    const tabla = document.getElementById('tablaUsuarios');
                    tabla.innerHTML = '';
                    
                    data.forEach(usuario => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${usuario.idUsuario}</td>
                            <td>${usuario.usuario}</td>
                            <td>${usuario.nombreCompleto}</td>
                            <td>${usuario.email}</td>
                            <td>${usuario.nombrePerfil}</td>
                            <td>${usuario.activo ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>'}</td>
                            <td>
                                <button class="btn btn-sm btn-warning btn-editar" data-id="${usuario.idUsuario}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-eliminar" data-id="${usuario.idUsuario}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tabla.appendChild(tr);
                    });
                    
                    // Agregar eventos a los botones
                    document.querySelectorAll('.btn-editar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            editarUsuario(id);
                        });
                    });
                    
                    document.querySelectorAll('.btn-eliminar').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            if (confirm('¿Está seguro de desactivar este usuario?')) {
                                eliminarUsuario(id);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar los usuarios');
                });
        }
        
        // Función para editar usuario
        function editarUsuario(id) {
            fetch(`https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/usuarios.php?id=${id}`)
                .then(response => response.json())
                .then(usuario => {
                    document.getElementById('modalTitulo').textContent = 'Editar Usuario';
                    document.getElementById('idUsuario').value = usuario.idUsuario;
                    document.getElementById('usuario').value = usuario.usuario;
                    document.getElementById('nombreCompleto').value = usuario.nombreCompleto;
                    document.getElementById('email').value = usuario.email;
                    document.getElementById('idPerfil').value = usuario.idPerfil;
                    document.getElementById('contrasena').required = false;
                    
                    usuarioModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar el usuario');
                });
        }
        
        // Función para eliminar usuario
        function eliminarUsuario(id) {
            fetch('https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/usuarios.php', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + JSON.parse(localStorage.getItem('user')).idUsuario
                },
                body: JSON.stringify({ id: id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarUsuarios();
                } else {
                    alert('Error al eliminar el usuario: ' + (data.error || ''));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        }
    });
</script>