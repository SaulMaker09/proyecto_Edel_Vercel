<div class="container">
    <h1>Gestión de Perfiles</h1>
    
    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-primary" id="btnNuevoPerfil">
            <i class="bi bi-plus"></i> Nuevo Perfil
        </button>
    </div>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Descripción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaPerfiles">
                <!-- Datos se cargarán dinámicamente -->
            </tbody>
        </table>
    </div>
</div>

<!-- Modal para agregar/editar perfil -->
<div class="modal fade" id="perfilModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTituloPerfil">Nuevo Perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="perfilForm">
                    <input type="hidden" id="idPerfil">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nombrePerfil" class="form-label">Nombre del Perfil</label>
                            <input type="text" class="form-control" id="nombrePerfil" required>
                        </div>
                        <div class="col-md-6">
                            <label for="descripcionPerfil" class="form-label">Descripción</label>
                            <input type="text" class="form-control" id="descripcionPerfil">
                        </div>
                    </div>
                    
                    <h5 class="mt-4">Permisos</h5>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Módulo</th>
                                    <th class="text-center">Consultar</th>
                                    <th class="text-center">Agregar</th>
                                    <th class="text-center">Editar</th>
                                    <th class="text-center">Eliminar</th>
                                </tr>
                            </thead>
                            <tbody id="permisosContainer">
                                <!-- Permisos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarPerfil">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const perfilModal = new bootstrap.Modal(document.getElementById('perfilModal'));
        let modulos = [];
        
        // Cargar módulos para permisos
        fetch('https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/modulos.php')
            .then(response => response.json())
            .then(data => {
                modulos = data;
                
                // Cargar perfiles
                cargarPerfiles();
            });
        
        // Abrir modal para nuevo perfil
        document.getElementById('btnNuevoPerfil').addEventListener('click', function() {
            document.getElementById('modalTituloPerfil').textContent = 'Nuevo Perfil';
            document.getElementById('perfilForm').reset();
            document.getElementById('idPerfil').value = '';
            
            // Cargar módulos para permisos
            cargarModulosParaPermisos();
            
            perfilModal.show();
        });
        
        // Guardar perfil
        document.getElementById('btnGuardarPerfil').addEventListener('click', function() {
            const formData = {
                idPerfil: document.getElementById('idPerfil').value,
                nombrePerfil: document.getElementById('nombrePerfil').value,
                descripcion: document.getElementById('descripcionPerfil').value,
                permisos: []
            };
            
            // Recoger permisos
            document.querySelectorAll('[data-modulo]').forEach(row => {
                const idModulo = row.getAttribute('data-modulo');
                formData.permisos.push({
                    idModulo: idModulo,
                    puedeConsultar: row.querySelector('.consultar').checked ? 1 : 0,
                    puedeAgregar: row.querySelector('.agregar').checked ? 1 : 0,
                    puedeEditar: row.querySelector('.editar').checked ? 1 : 0,
                    puedeEliminar: row.querySelector('.eliminar').checked ? 1 : 0
                });
            });
            
            const url = 'https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/perfiles.php';
            const method = formData.idPerfil ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + JSON.parse(localStorage.getItem('user')).idUsuario
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    perfilModal.hide();
                    cargarPerfiles();
                } else {
                    alert('Error al guardar el perfil: ' + (data.error || ''));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        });
        
        // Función para cargar perfiles
        function cargarPerfiles() {
            fetch('https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/perfiles.php')
                .then(response => response.json())
                .then(data => {
                    const tabla = document.getElementById('tablaPerfiles');
                    tabla.innerHTML = '';
                    
                    data.forEach(perfil => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${perfil.idPerfil}</td>
                            <td>${perfil.nombrePerfil}</td>
                            <td>${perfil.descripcion || ''}</td>
                            <td>
                                <button class="btn btn-sm btn-warning btn-editar-perfil" data-id="${perfil.idPerfil}">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger btn-eliminar-perfil" data-id="${perfil.idPerfil}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tabla.appendChild(tr);
                    });
                    
                    // Agregar eventos a los botones
                    document.querySelectorAll('.btn-editar-perfil').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            editarPerfil(id);
                        });
                    });
                    
                    document.querySelectorAll('.btn-eliminar-perfil').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            if (confirm('¿Está seguro de eliminar este perfil?')) {
                                eliminarPerfil(id);
                            }
                        });
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar los perfiles');
                });
        }
        
        // Función para cargar módulos para permisos
        function cargarModulosParaPermisos(permisos = []) {
            const container = document.getElementById('permisosContainer');
            container.innerHTML = '';
            
            modulos.forEach(modulo => {
                const permiso = permisos.find(p => p.idModulo == modulo.idModulo) || {};
                
                const tr = document.createElement('tr');
                tr.setAttribute('data-modulo', modulo.idModulo);
                tr.innerHTML = `
                    <td>${modulo.nombreModulo}</td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input consultar" ${permiso.puedeConsultar ? 'checked' : ''}>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input agregar" ${permiso.puedeAgregar ? 'checked' : ''}>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input editar" ${permiso.puedeEditar ? 'checked' : ''}>
                    </td>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input eliminar" ${permiso.puedeEliminar ? 'checked' : ''}>
                    </td>
                `;
                container.appendChild(tr);
            });
        }
        
        // Función para editar perfil
        function editarPerfil(id) {
            fetch(`https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/perfiles.php?id=${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('modalTituloPerfil').textContent = 'Editar Perfil';
                    document.getElementById('idPerfil').value = data.perfil.idPerfil;
                    document.getElementById('nombrePerfil').value = data.perfil.nombrePerfil;
                    document.getElementById('descripcionPerfil').value = data.perfil.descripcion || '';
                    
                    // Cargar permisos
                    cargarModulosParaPermisos(data.permisos);
                    
                    perfilModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al cargar el perfil');
                });
        }
        
        // Función para eliminar perfil
        function eliminarPerfil(id) {
            fetch('https://goldenrod-grouse-151833.hostingersite.com/perfiles.php/perfiles.php', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + JSON.parse(localStorage.getItem('user')).idUsuario
                },
                body: JSON.stringify({ id: id })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    cargarPerfiles();
                } else {
                    alert('Error al eliminar el perfil: ' + (data.error || ''));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al conectar con el servidor');
            });
        }
    });
</script>